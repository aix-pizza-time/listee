stages:
  - build
  - deploy

build:
  stage: build
  image: docker:latest
  script:
    - echo "$CI_JOB_TOKEN" | docker login registry.git.rwth-aachen.de --username gitlab-ci-token --password-stdin 
    - docker build -t registry.git.rwth-aachen.de/occloxium-webdev/pizzabot/backend ./server
    - docker build -t registry.git.rwth-aachen.de/occloxium-webdev/pizzabot/frontend ./client
    - docker push registry.git.rwth-aachen.de/occloxium-webdev/pizzabot/frontend:latest 
    - docker push registry.git.rwth-aachen.de/occloxium-webdev/pizzabot/backend:latest
  tags:
    - occloxium-docker

deploy:
  stage: deploy
  image: registry.git.rwth-aachen.de/zoomoid/docker-kubectl:latest
  script: 
    # - cat /admin.conf
    # - $kube_config | base64 -d >> /admin.conf
    # - alias k="kubectl --kubeconfig /admin.conf"
    - k rollout restart -n web pizzabot-frontend
    - k rollout restart -n web pizzabot-backend
  tags:
    - occloxium-docker