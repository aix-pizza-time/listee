stages:
  - build
  - deploy

build:
  stage: build
  image: docker:latest
  script:
    - echo "$CI_JOB_TOKEN" | docker login registry.git.rwth-aachen.de --username gitlab-ci-token --password-stdin 
    - docker build -t registry.git.rwth-aachen.de/occloxium-webdev/pizzabot/backend ./server
    - docker build -t registry.git.rwth-aachen.de/occloxium-webdev/pizzabot/frontend ./client
    - docker push registry.git.rwth-aachen.de/occloxium-webdev/pizzabot/frontend:latest 
    - docker push registry.git.rwth-aachen.de/occloxium-webdev/pizzabot/backend:latest
  tags:
    - occloxium-docker

deploy:
  stage: deploy
  script:
    - kubectl rollout restart -n web pizzabot-frontend
    - kubectl rollout restart -n web pizzabot-backend
  tags:
    - cluster